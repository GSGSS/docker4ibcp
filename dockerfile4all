# ibcp全模块镜像
# 基于tomcat镜像的ibcp镜像
# OS：debian:jessie
FROM tomcat:8.5.5-jre8

# 作者
MAINTAINER Niuren.Zhu "niuren.zhu@outlook.com"

# 定义参数 
# 程序包-发布服务地址
ARG IBCP_PACKAGE_URL=http://ibas.club:8866/ibcp
# 程序包-发布服务用户名
ARG IBCP_PACKAGE_USER=avatech/\amber
# 程序包-发布服务用户密码
ARG IBCP_PACKAGE_PASSWORD=Aa123456
# 程序包-版本路径
ARG IBCP_PACKAGE_VERSION=latest
# 程序包-下载目录
ARG IBCP_PACKAGE_DOWNLOAD=~/ibcp_packages

# 定义环境变量
ENV \
# ibcp配置目录
    IBCP_CONF=/srv/ibcp/conf \
# ibcp数据目录
    IBCP_DATA=/srv/ibcp/data \
# ibcp日志目录
    IBCP_LOG=/srv/ibcp/log
# 其他使用的环境变量
# CATALINA_HOME，tomcat目录

# 创建数据文件夹
RUN mkdir -p "${IBCP_PACKAGE_DOWNLOAD}"; \
    mkdir -p "${IBCP_CONF}"; \
    mkdir -p "${IBCP_DATA}"; \
    mkdir -p "${IBCP_LOG}";

# 部署ibcp程序
RUN set -x \
# 下载ibcp的最新war包
    && wget -r -np -nd -nv -P ${IBCP_PACKAGE_DOWNLOAD} --http-user=${IBCP_PACKAGE_USER} --http-password=${IBCP_PACKAGE_PASSWORD} ${IBCP_PACKAGE_URL}/${IBCP_PACKAGE_VERSION}/ \
# 释放war包
    && (for file in `ls "${IBCP_PACKAGE_DOWNLOAD}" | grep .war`; \
       do \
# 修正war包的解压目录
         folder=${file##*ibcp.}; \
         folder=${folder%%.service*}; \
# 记录释放的目录到ibcp.release
         if [ ! -e "${CATALINA_HOME}/webapps/ibcp.release" ]; then echo >>"${CATALINA_HOME}/webapps/ibcp.release"; fi; \
         if [ `grep -q "${folder}" "${CATALINA_HOME}/webapps/ibcp.release"` ];then echo "${folder}" >>"${CATALINA_HOME}/webapps/ibcp.release"; fi; \
# 解压war包到tomcat目录
         unzip -o "${IBCP_PACKAGE_DOWNLOAD}/${file}" -d "${CATALINA_HOME}/webapps/${folder}"; \
# 删除配置文件，并映射到统一位置
         if [ -e "${CATALINA_HOME}/webapps/${folder}/WEB-INF/app.xml" ]; then \
           if [ ! -e "${IBCP_CONF}/app.xml" ]; then cp -f "${CATALINA_HOME}/webapps/${folder}/WEB-INF/app.xml" "${IBCP_CONF}/app.xml"; fi; \
           rm -f "${CATALINA_HOME}/webapps/${folder}/WEB-INF/app.xml"; \
           ln -s "${IBCP_CONF}/app.xml" "${CATALINA_HOME}/webapps/${folder}/WEB-INF/app.xml"; \
         fi; \
# 删除服务路由文件，并映射到统一位置
         if [ -e "${CATALINA_HOME}/webapps/${folder}/WEB-INF/service_routing.xml" ]; then \
           if [ ! -e "${IBCP_CONF}/service_routing.xml" ]; then cp -f "${CATALINA_HOME}/webapps/${folder}/WEB-INF/service_routing.xml" "${IBCP_CONF}/service_routing.xml"; fi; \
           rm -f "${CATALINA_HOME}/webapps/${folder}/WEB-INF/service_routing.xml"; \
           ln -s "${IBCP_CONF}/service_routing.xml" "${CATALINA_HOME}/webapps/${folder}/WEB-INF/service_routing.xml"; \
         fi; \
# 映射日志文件夹到统一位置
         if [ ! -e "${CATALINA_HOME}/webapps/${folder}/WEB-INF/log" ]; then mkdir -p "${CATALINA_HOME}/webapps/${folder}/WEB-INF/log"; fi; \
         ln -s -d "${IBCP_LOG}" "${CATALINA_HOME}/webapps/${folder}/WEB-INF/log"; \
       done;) \
# 删除下载的包
    && rm -rf "${IBCP_PACKAGE_DOWNLOAD}"

# 拷贝配置文件
COPY "ibcp.app.xml" "${IBCP_CONF}/app.xml"
COPY "ibcp.service_routing.xml" "${IBCP_CONF}/service_routing.xml"

# 映射ibcp数据目录
VOLUME ["${IBCP_CONF}","${IBCP_DATA}"]

# 运行tomcat
WORKDIR "$CATALINA_HOME"
# CMD ["catalina.sh", "run"]
